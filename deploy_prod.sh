#!/bin/bash

# YouTube Video Downloader - Production Deployment

echo "ğŸš€ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ YouTube Video Downloader Ğ² Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞ½..."

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Docker
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Docker ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ°."
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "âŒ Docker Compose Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Docker Compose ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ°."
    exit 1
fi

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ production .env Ñ„Ğ°Ğ¹Ğ»Ğ°
if [ ! -f backend/.env ]; then
    echo "âš™ï¸ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ production .env Ñ„Ğ°Ğ¹Ğ»Ğ°..."
    cat > backend/.env << EOF
# Production Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
APP_NAME=YouTube Video Downloader
ENVIRONMENT=production
DEBUG=false

# Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
DATABASE_URL=postgresql://postgres:postgres@postgres:5432/youtube_downloader

# Redis Ğ¸ Celery
REDIS_URL=redis://redis:6379/0
CELERY_BROKER_URL=redis://redis:6379/0
CELERY_RESULT_BACKEND=redis://redis:6379/0

# Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°
DOWNLOAD_DIR=/app/downloads
MAX_FILE_SIZE_MB=500
FILE_RETENTION_HOURS=24

# Rate limiting
RATE_LIMIT_DOWNLOADS_PER_HOUR=10
RATE_LIMIT_DOWNLOADS_PER_DAY=50

# Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ
SECRET_KEY=$(openssl rand -hex 32)
EOF
fi

# Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ² production Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ
echo "ğŸ³ Ğ—Ğ°Ğ¿ÑƒÑĞº ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²..."
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

echo "â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²..."
sleep 10

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
echo "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²..."
docker-compose ps

echo "âœ… Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½!"
echo ""
echo "ğŸŒ ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ: http://localhost"
echo "ğŸ“š API Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ: http://localhost/api/docs"
echo ""
echo "Ğ”Ğ»Ñ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸: docker-compose down"
echo "Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ğ»Ğ¾Ğ³Ğ¾Ğ²: docker-compose logs -f"
